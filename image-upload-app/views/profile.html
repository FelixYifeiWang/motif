<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Home</title>

  <!-- Favicon -->
  <link rel="icon" href="/assets/favicon.png" type="image/png">

  <!-- Google Fonts for Amiri -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Antic+Didone&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Gruppo&display=swap" rel="stylesheet">


  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
        overflow-x: hidden; /* Prevents horizontal scrolling */
        width: 100vw; /* Sets the width to viewport width */
        margin: 0; /* Ensures no extra space */
    }
    body {
      font-family: 'Amiri', serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #FFFFFF;
      overflow-x: hidden;
    }

    /* Warning Message for Desktop Users */
    .desktop-warning {
      display: none;
      text-align: center;
      color: #333;
      font-size: 3vw;
      font-family: 'Amiri', serif;
      position: fixed;
      top: 40vh;
      width: 100vw;
      text-align: center;
    }

    /* Main Container for Mobile Layout */
    .mobile-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: absolute;
      width: 100vw;
      max-width: 600px;
      top: 0;
    }
    .logo {
      position: absolute;
      top: 6vh;
      left: 6vw;
      width: 18.6vw;
      max-width: 100px;
      z-index: 1000;
    }

    .namecard {
      position: absolute;
      top: 21vw;
      left: 6vw;
      width: 88vw;
      z-index: 1000;
    }

    .msg {
      position: absolute;
      top: 83.5vw;
      right: 7vw;
      z-index: 1000;
      text-align: right;
      font-family: "Gruppo", sans-serif;
      font-weight: 400;
      font-style: normal;
      color: #494949;
      font-size: 3.5vw;
      z-index: 1001;
    }

    .mystyle {
      position: absolute;
      top: 93vw;
      left: 7vw;
      z-index: 1000;
      text-align: left;
      font-family: "Antic Didone", serif;
      font-weight: 400;
      font-style: normal;
      font-size: 4vw;
      z-index: 1001;
    }

    .namecardcard {
      position: absolute;
      width: 88vw;
    }

    .username {
      position: absolute;
      top: 7vw;
      left: 5vw;
      font-family: "Antic Didone", serif;
      font-weight: 400;
      font-style: normal;
      font-size: 7vw;
      z-index: 1001;
      text-align: left;
    }

    .outfits {
      position: absolute;
      top: 27vw;
      left: 5vw;
      font-family: "Gruppo", sans-serif;
      font-weight: 400;
      font-style: normal;
      font-size: 10vw;
      text-align: left;
      z-index: 1001;
    }

    .join {
      position: absolute;
      top: 49.5vw;
      left: 5vw;
      width: 13.5vw;
      font-family: "Gruppo", sans-serif;
      font-weight: 400;
      font-style: normal;
      font-size: 4vw;
      text-align: center;
      z-index: 1001;
    }

    .styles {
      position: absolute;
      top: 49.5vw;
      left: 26.7vw;
      width: 22vw;
      font-family: "Gruppo", sans-serif;
      font-weight: 400;
      font-style: normal;
      font-size: 4vw;
      text-align: center;
      z-index: 1001;
    }

    .streak {
      position: absolute;
      top: 49.5vw;
      left: 57vw;
      width: 8.5vw;
      font-family: "Gruppo", sans-serif;
      font-weight: 400;
      font-style: normal;
      font-size: 4vw;
      text-align: center;
      z-index: 1001;
    }

    .bottombar {
      position: fixed;
      bottom: -6vw;
      width: 100vw;
      z-index: 10000;
    }

    .camera {
      position: fixed;
      bottom: 5vw;
      width: 21vw;
      z-index: 10001;
    }

    .ootd {
      position: fixed;
      bottom: 7.3vw;
      left: 18vw;
      font-family: "Gruppo", sans-serif;
      font-weight: 400;
      font-style: normal;
      font-size: 4.5vw;
      z-index: 10001;
      -webkit-text-stroke: 0.1vw black;
      opacity: 0.6;
    }

    .profile {
      position: fixed;
      bottom: 7.3vw;
      right: 18vw;
      font-family: "Gruppo", sans-serif;
      font-weight: 400;
      font-style: normal;
      font-size: 4.5vw;
      z-index: 10001;
      -webkit-text-stroke: 0.1vw black;
    }

    .ootd :hover {
      opacity: 1;
    }

    .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 5vw;
        margin-top: 100vw;
        width: 90vw;
        margin-bottom: 30vw;
    }

    .card {
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .card-image {
        width: 100%;
        height: auto;
        object-fit: cover;
    }

    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 40vw;
        position: relative;
        top: -5.3vw;
        left: -1.2vw;
    }

    .level {
        position: relative;
        font-size: 2.5vw;
        font-family: "Gruppo", sans-serif;
        color: black;
        top: -2.5vw;
        right: -35vw;
        z-index: 10001;
    }

    .progress-bar {
        position: relative;
        width: 88%;
        height: 1.5vw;
        background-color: #D9D9D9;
        overflow: hidden;
        top: 0;
        left: 0;
    }

    .progress {
        height: 100%;
        background-color: #0F0F0F;
    }

    .analyzing-text {
      display: none;
      position: fixed;
      top: 45vh;
      width: 70vw;
      left: 5vw;
      cursor: pointer;
    }

    
    .fade-in-bg {
      animation: fadeInBg 3s ease forwards;
    }

    .fade-out-bg {
      animation: fadeOutBg 5s ease forwards;
    }

    .pulsing {
      animation: pulse 3s ease-in-out infinite;
      transform-origin: left;
    }

    @keyframes pulse {
      0% {
        opacity: 0.5;
        transform: scale(1);
      }
      50% {
        opacity: 1;
        transform: scale(1.05); /* Slightly enlarges for a 'breathing' effect */
      }
      100% {
        opacity: 0.5;
        transform: scale(1);
      }
    }

    @keyframes fadeInBg {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeOutBg {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 1; /* Slower fade-out for the first half */
      }
      100% {
        opacity: 0; /* Faster fade-out in the later half */
      }
    }

    /* Fade In Animation */
    .fade-in {
      animation: fadeIn 1s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* Slide In (from Right to Left) Animation */
    .side-slide-in {
      animation: sideslideIn 0.8s ease forwards;
    }

    @keyframes sideslideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Slide Out (from Left to Right) Animation */
    .side-slide-out {
      animation: sideslideOut 0.8s ease forwards;
    }

    @keyframes sideslideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Emerge Animation */
    .emerge {
      animation: emerge 1s ease forwards;
    }

    @keyframes emerge {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .slide-in {
        opacity: 0;
        animation: slidein 1s ease forwards;
        transform: translateY(10px); /* Starting point for slide-in */
        /* transition: opacity 1.5s ease-out, transform 1.5s ease-out; */
    }

    @keyframes slidein {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .scroll-in {
        opacity: 0;
        transform: translateY(30px); /* Starting point for slide-in */
        transition: opacity 1.5s ease-out, transform 1.5s ease-out;
    }

    /* Triggered slide-in effect */
    .scroll-in-visible {
        opacity: 1;
        transform: translateX(0);
    }
  </style>
</head>
<body>

  <!-- Warning Message for Desktop Users -->
  <div class="desktop-warning">
    Please view this page on a mobile device.
  </div>
  <!-- Mobile Container -->
  <div class="mobile-container hide-on-desktop">
    <!-- Logo Image -->
    <img src="/assets/logo.png" alt="Motif Logo" class="logo fade-in">
    <div class="namecard slide-in">
      <img src="/assets/namecard.png" alt="Motif Card" class="namecardcard">
      <div class="username" id="username">Placeholder</div>
      <div class="outfits" id="outfits">888</div>
      <div class="join" id="join">88/8888</div>
      <div class="styles" id="styles">8</div>
      <div class="streak" id="streak">8</div>
    </div>
    <div class="msg fade-in">
      Get notified for our App Store launch<br>instagram @motif.app.official
    </div>
    <div class="mystyle fade-in">
      My Style
    </div>
    <div class="gallery">
      <div class="card scroll-in" id="card1">
          <img src="/assets/casual.png" class="card-image" >
          <div class="card-footer">
              <span class="level">Lv 1</span>
              <div class="progress-bar">
                  <div class="progress" style="width: 40%;"></div>
              </div>
          </div>
      </div>
      <div class="card scroll-in" id="card2">
          <img src="/assets/edgy.png" class="card-image">
          <div class="card-footer">
              <span class="level">Lv 1</span>
              <div class="progress-bar">
                  <div class="progress" style="width: 40%;"></div>
              </div>
          </div>
      </div>
      <div class="card scroll-in" id="card3">
          <img src="/assets/minimalist.png" class="card-image">
          <div class="card-footer">
              <span class="level">Lv 1</span>
              <div class="progress-bar">
                  <div class="progress" style="width: 40%;"></div>
              </div>
          </div>
      </div>
      <div class="card scroll-in" id="card4">
          <img src="/assets/sophisticated.png" class="card-image">
          <div class="card-footer">
              <span class="level">Lv 1</span>
              <div class="progress-bar">
                  <div class="progress" style="width: 40%;"></div>
              </div>
          </div>
      </div>
      <div class="card scroll-in" id="card5">
          <img src="/assets/athleisure.png" class="card-image">
          <div class="card-footer">
              <span class="level">Lv 1</span>
              <div class="progress-bar">
                  <div class="progress" style="width: 40%;"></div>
              </div>
          </div>
      </div>
      <div class="card scroll-in" id="card6">
          <img src="/assets/romantic.png" class="card-image">
          <div class="card-footer">
              <span class="level">Lv 1</span>
              <div class="progress-bar">
                  <div class="progress" style="width: 40%;"></div>
              </div>
          </div>
      </div>
      <div class="card scroll-in" id="card7">
          <img src="/assets/bohemian.png" class="card-image">
          <div class="card-footer">
              <span class="level">Lv 1</span>
              <div class="progress-bar">
                  <div class="progress" style="width: 40%;"></div>
              </div>
          </div>
      </div>
      <div class="card scroll-in" id="card8">
          <img src="/assets/street.png" class="card-image">
          <div class="card-footer">
              <span class="level">Lv 1</span>
              <div class="progress-bar">
                  <div class="progress" style="width: 40%;"></div>
              </div>
          </div>
      </div>
      <div class="card scroll-in" id="card9">
          <img src="/assets/glam.png" class="card-image">
          <div class="card-footer">
              <span class="level">Lv 1</span>
              <div class="progress-bar">
                  <div class="progress" style="width: 40%;"></div>
              </div>
          </div>
      </div>
      <div class="card scroll-in">
          <img src="/assets/other.png" class="card-image">
      </div>
      <!-- Add more cards as needed -->
  </div>
  </div>

  <img class="bottombar fade-in" src="/assets/bottombar.png">
  <img class="camera fade-in" src="/assets/camera.png" onclick="triggerFileInput()">
  <div class="ootd fade-in" id="ootdButton">ootd</div>
  <div class="profile fade-in">profile</div>

  <img src="/assets/analyze-text.png" class="analyzing-text pulsing" id="analyzingText" alt="Analyzing your Designer DNA...">

  <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
  <script>
    function isInViewport(element) {
        const rect = element.getBoundingClientRect();
        return rect.top >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight);
    }


    function animateElements() {
        // console.log(1);
        const slideElements = document.querySelectorAll('.scroll-in');
        // const toptwo = document.querySelectorAll('.special');
        // console.log(toptwo)
        // toptwo.forEach((element) => {
        //     console.log(2);
        //     element.classList.add('scroll-in-visible');
        // });
        slideElements.forEach((element) => {
            if (isInViewport(element)) {
                element.classList.add('scroll-in-visible');
            }
        });
        
    }

    // Run animation on scroll
    window.addEventListener('scroll', animateElements);

    var imageNum = 0;
    document.getElementById("ootdButton").addEventListener("click", function() {
        window.location.href = "/home";
    });

    async function fetchUser() {
        try {
            const response = await fetch('/upload/user', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            });
            const user = await response.json();
            const response1 = await fetch('/upload/list', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            });
            const images = await response1.json();
            images.sort((a, b) => {
                return new Date(b.upload_date) - new Date(a.upload_date);
            });

            document.getElementById(`username`).innerHTML = user.name;
            document.getElementById(`outfits`).innerHTML = images.length;
            imageNum = images.length;
            const dateObj = new Date(user.join_time);
            const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed, so we add 1
            const year = dateObj.getFullYear();
            const formattedDate = `${month}/${year}`;
            document.getElementById(`join`).innerHTML = formattedDate;

            const styles = user.styles;
            const nonZeroCount = Object.values(styles).filter(score => score !== 0).length;
            const rank = Object.entries(styles)
              .sort((a, b) => b[1] - a[1]) // Sort by score (value) in descending order
              .map(entry => entry[0]);

            document.getElementById(`styles`).innerHTML = nonZeroCount;

            function convertToEST(date) {
                const utcDate = new Date(date);
                const offset = utcDate.getTimezoneOffset() / 60; // Timezone offset in hours
                utcDate.setHours(utcDate.getHours() - offset - 5); // Adjust for EST (UTC-5) or EDT (UTC-4)
                return utcDate;
            }

            // Create a set of unique dates in EST, formatted as "YYYY-MM-DD"
            const imageDates = new Set(images.map(image => {
                const estDate = convertToEST(image.upload_date);
                return estDate.toISOString().split('T')[0]; // Format as YYYY-MM-DD
            }));

            // Start counting consecutive days with at least one image
            let consecutiveDays = 0;
            let currentDate = new Date();
            currentDate = convertToEST(currentDate);

            // Check each day, going back one day at a time
            while (imageDates.has(currentDate.toISOString().split('T')[0])) {
                consecutiveDays++;
                // Move to the previous day
                currentDate.setDate(currentDate.getDate() - 1);
            }

            document.getElementById(`streak`).innerHTML = consecutiveDays;
            
            const exp = 60;

            rank.forEach((style, index) => {
              const card = document.getElementById(`card${index + 1}`);
              if (card) {
                const img = card.querySelector(".card-image");
                const levelSpan = card.querySelector(".level");
                const progressBar = card.querySelector(".progress");
                img.src = `/assets/${style}.png`; // Update the src with the corresponding style image
                
                const score = styles[style];
                const level = Math.floor(score / exp);
                const progressPercent = ((score % exp) / exp) * 100;

                // Update level text
                levelSpan.textContent = `Lv ${level}`;

                // Update progress bar width
                progressBar.style.width = `${progressPercent}%`;
              }
            });

        } catch (error) {
            console.error('Error fetching user info:', error);
        }
    }

    window.onload = async function() {
        await fetchUser();
        animateElements();
    };

    function checkScreenWidth() {
      if (window.innerWidth > 768) {
        document.querySelector('.desktop-warning').style.display = 'block';
        document.querySelector('.hide-on-desktop').style.display = 'none';
        document.querySelectorAll('body').forEach(element => {
            element.style.display = 'none';
        });
      } else {
        document.querySelector('.desktop-warning').style.display = 'none';
        document.querySelector('.hide-on-desktop').style.display = 'flex';
      }
    }

    // Initial check and resize event listener
    checkScreenWidth();
    window.addEventListener('resize', checkScreenWidth);

    function triggerFileInput() {
        document.getElementById("fileInput").click();
    }

    // Function to handle file selection or capture
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            // Display the selected file or do something with it
            console.log("Selected file:", file);
        }
    }

    // handle uplaod

    var file_input;
    const formDataAI = new FormData();
    var aires;
    var designer_name;
    var comment;
    var intro;
    var tags;

    function triggerFileInput() {
        document.getElementById("fileInput").click();
    }

    // Function to handle file selection or capture
    async function handleFileSelect(event) {
      const file = document.getElementById('fileInput');
      file_input = file.files[0];

      if (!file_input) {
          alert("Please upload an image.");
          return;
      }

      document.querySelectorAll('body > *:not(.logo)').forEach(element => {
          element.style.display = 'none';
      });

      // Show analyzing text
      document.querySelectorAll('.analyzing-text').forEach(element => {
          element.style.display = 'block';
      });

      console.log(1);

      try {
        const compressedFile = await compressImage(file_input);
        console.log(2);
        file_input = compressedFile;
      } catch (error) {
          console.error('Error during image compression:', error);
          return;
      }      
      formDataAI.append('images', file_input);

      // Send file to OpenAI API (placeholder function)
      analyzeImage();
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // Create a canvas to draw the image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Set desired dimensions (you can adjust this)
                    const maxWidth = 800;
                    const scaleFactor = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleFactor;

                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Convert to a compressed JPEG with quality of 0.7
                    canvas.toBlob(
                        blob => {
                            if (blob) {
                                const compressedFile = new File([blob], file.name, { type: 'image/jpeg' });
                                console.log(`Compressed file size for ${file.name}: ${compressedFile.size} bytes`);
                                resolve(compressedFile);
                            } else {
                                reject(new Error('Compression failed'));
                            }
                        },
                        'image/jpeg',
                        0.7
                    );
                };

                img.onerror = () => {
                    reject(new Error('Failed to load image for compression'));
                };

                img.src = event.target.result;
            };

            reader.onerror = () => {
                reject(new Error('File reading failed'));
            };

            reader.readAsDataURL(file);
        });
    }
    async function analyzeImage() {
        console.log("Sending image to OpenAI API...");

        try {
            console.log(formDataAI);
            // Send file to OpenAI analysis API
            const response = await fetch('/api/openai/analyze-images', {
                method: 'POST',
                body: formDataAI,
            });
            const result = await response.json();
            if (response.ok) {
                const aires = result.results[0];
                console.log(aires); 

                try {
                    designer_name = aires["designer"];
                } catch (error) {
                    designer_name = "Unknown";
                    console.error('Error getting designer name:', error);
                }
                try {
                    comment = aires["compliment"];
                    intro = aires["desc_sentence1"] + "<br><br>" + aires["desc_sentence2"];
                } catch (error) {
                    comment = "Unknown";
                    intro = "Unknown";
                    console.error('Error getting comments:', error);
                }
                try {
                    tags = aires["tags"];
                } catch (error) {
                    tags = ["casual", "other"];
                    console.error('Error getting comments:', error);
                }
                const filesArray = [];
                filesArray.push({
                  data: await fileToBase64(file_input), // Convert file to base64 for storage
                  name: file_input.name,
                  type: file_input.type,
                });
                sessionStorage.setItem('pendingUploadFilesNew', JSON.stringify(filesArray));
                sessionStorage.setItem('pendingUploadCommentNew', JSON.stringify(comment));
                sessionStorage.setItem('pendingUploadTagsNew', JSON.stringify(tags));
                sessionStorage.setItem('pendingUploadImageNum', JSON.stringify(imageNum));

                console.log(sessionStorage);

                const formDataUpload = new FormData();
                formDataUpload.append('images', file_input, file_input.name);
                formDataUpload.append('tags', tags);
                try {
                  // Upload images and tags to the server
                  const response = await fetch('/upload', {
                    method: 'POST',
                    body: formDataUpload,
                  });

                  const user_response = await fetch('/upload/user', {
                      method: 'GET',
                      headers: { 'Content-Type': 'application/json' },
                  });
                  
                  const user = await user_response.json();
                  const styles = user["styles"];
                  const formData1 = new FormData();
                  styles[tags[0]] = styles[tags[0]] + 100;
                  styles[tags[1]] = styles[tags[1]] + 50;
                  formData1.append('tags', JSON.stringify(styles));

                  const response1 = await fetch('/upload/update-styles', {
                    method: 'POST',
                    body: formData1,
                  });

                  console.log(response1);

                  if (response && response.ok) {
                    console.log('Images uploaded successfully');
                  } else {
                    console.error('Image upload failed:', response.status);
                  }
                } catch (error) {
                  console.error('Error uploading images:', error);
                }

                window.location.href = "/display";
            }
        } catch (error) {
            console.error('Error analyzing image:', error);
        }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
  </script>

</body>
</html>

