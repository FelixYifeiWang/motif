<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motif</title>

  <!-- Favicon -->
  <link rel="icon" href="/assets/favicon.png" type="image/png">

  <!-- Google Fonts for Amiri -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Antic+Didone&display=swap" rel="stylesheet">


  <style>
    /* Reset and Basic Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Amiri', serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #F4F4F4;
      overflow: hidden;
    }

    /* Warning Message for Desktop Users */
    .desktop-warning {
      display: none;
      text-align: center;
      color: #333;
      font-size: 3vw;
      font-family: 'Amiri', serif;
      position: fixed;
      top: 40vh;
      width: 100vw;
      text-align: center;
    }

    /* Main Container for Mobile Layout */
    .mobile-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      width: 100vw;
      max-width: 600px;
    }

    .bg {
      position: fixed;
      height: 100vh;
      top: 0;
      z-index: -20;
    }

    .bg2 {
      position: fixed;
      width: 100vw;
      top: 0;
      z-index: -20;
    }

    /* Images - Logo */
    .logo {
      position: fixed;
      top: 6vh;
      left: 6vw;
      width: 18.6vw;
      max-width: 100px;
      z-index: 1000;
    }

    /* Black Square Overlay for Upload Button */
    .black-square {
      position: fixed;
      top: 13vh;
      height: 63vh;
      margin-left: 1vh;
      cursor: pointer;
      z-index: 1;
    }

    /* OR Text */
    .or-text {
      position: fixed;
      bottom: 10vh;
      width: 42vw;
      z-index: 10;
    }

    /* Google Login Button */
    .login-button {
      position: fixed;
      bottom: 4vh;
      width: 36vw;
      cursor: pointer;
      z-index: 2000;
    }

    /* Analyzing Text */
    .analyzing-text {
      position: fixed;
      top: 45vh;
      width: 70vw;
      left: 5vw;
      cursor: pointer;
    }

    .analysis-result {
      display: none;
      position: fixed;
      top: 35vh;
      width: 80vw;
      left: 10vw;
      font-size: 4vw;
      color: #333;
      text-align: left;
      z-index: 2;
    }

    /* Additional Images under Result */
    .resultimage1 {
      display: none;
      position: fixed;
      top: 55vh;
      width: 37vw;
      height: 41.38vw;
      left: 10vw;
      z-index: 2;
    }

    .resultimage1 .icon-img {
      width: 37vw;
    }

    .resultimage2 .icon-img {
      width: 37vw;
    }

    .resultimage2 {
      display: none;
      position: fixed;
      top: 55vh;
      width: 37vw;
      right: 10vw;
      z-index: 2;
    }

    .resultimage1 .t100 {
      display: none;
      position: absolute;
      bottom: 2vw;
      width: 12vw;
      right: 3vw;
      z-index: 3;
    }

    .resultimage2 .t50 {
      display: none;
      position: absolute;
      bottom: 5vw;
      width: 10vw;
      right: 3vw;
      z-index: 3;
    }
  
    .dots {
      display: none;
      position: fixed;
      bottom: 6vh;
      width: 10vw;
    }

    .dna {
      display: none;
      position: fixed;
      top: 15vh;
      width: 110vw;
    }

    .dna .dna-img {
      width: 110vw;
    }

    .dna .designername {
      display: none;
      position: absolute;
      top: 13vh;
      width: 80vw;
      left: 12vw;
      font-family: 'Antic Didone', serif;
      font-size: 10vw;
      color: white;
      text-align: left;
      z-index: 1111;
      transform: rotate(-2deg);
    }

    .dna .designerdesc {
      display: none;
      position: absolute;
      bottom: 45vw;
      width: 60vw;
      right: 12vw;
      font-family: 'Amiri', serif;
      font-size: 4vw;
      line-height: 4vw;
      color: white;
      text-align: left;
      z-index: 1111;
      transform: rotate(-2deg);
    }

    .pg4bg {
      display: none;
      position: fixed;
      top: 10vh;
      width: 120vw;
    }

    .pg4bg .pg4img-left {
      position: absolute;
      width: 90vw;
      left: -5vw;
      z-index: 3;
    }
    
    .pg4bg .pg4img-right {
      position: absolute;
      width: 60vw;
      right: -5vw;
      top: 15vw;
      z-index: 1;
    }

    .pg4bg .overlaytxt {
      position: absolute;
      width: 70vw;
      left: 10vw;
      top: 13vw;
      z-index: 10;
    }

    .pg4bg .photo1 {
      position: absolute;
      width: 30vw;
      height: 67vw;
      top: 16vw;
      left: 10vw;
      z-index: 9;
      transform: rotate(-5.51deg);
      object-fit: cover; /* Cover the area of the div without stretching */
      object-position: center;
    }

    .pg4bg .photo2 {
      position: absolute;
      width: 21vw;
      height: 28.06vw;
      top: 48vw;
      left: 52vw;
      z-index: 9;
      transform: rotate(-5.07deg);
      object-fit: cover; /* Cover the area of the div without stretching */
      object-position: center;
    }

    .pg4bg .photo3 {
      position: absolute;
      width: 33vw;
      height: 55.89vw;
      right: 10vw;
      top: 20vw;
      z-index: 2;
      object-fit: cover; /* Cover the area of the div without stretching */
      object-position: center;
    }

    .designername1 {
      display: none;
      position: fixed;
      top: 131vw;
      left: 8vw;
      font-family: 'Antic Didone', serif;
      font-size: 5vw;
      color: black;
      text-align: left;
      z-index: 1111;
    }

    .designerdesc1 {
      display: none;
      position: fixed;
      top: 140vw;
      left: 8vw;
      width: 84vw;
      font-family: 'Amiri', serif;
      font-size: 4vw;
      line-height: 4vw;
      color: black;
      text-align: left;
      z-index: 1111;
    }

    .page2 .page3 {
      display: none;
    }
  </style>
</head>
<body>

  <!-- Warning Message for Desktop Users -->
  <div class="desktop-warning">
    Please view this page on a mobile device.
  </div>

  <!-- Mobile Container -->
  <div class="mobile-container hide-on-desktop">

    <!-- Background -->
    <img src="/assets/bg1.png" alt="" class="bg page1">

    <!-- Logo Image -->
    <img src="/assets/logo.png" alt="Motif Logo" class="logo">

    <!-- Black Square Image with Click Event (Upload Outfits Button) -->
    <img src="/assets/first-upload.png" alt="Upload Outfits Button" class="black-square page1" onclick="handleBlackSquareClick()">

    <!-- OR Text Image -->
    <img src="/assets/or.png" alt="OR" class="or-text page1">

    <!-- Google Login Button Image with Click Event -->
    <img src="/assets/login.png" alt="Log in with Google" class="login-button page1" onclick="handleLoginClick()">

    <img src="/assets/analyze-text.png" alt="OR" class="analyzing-text page2" id="analyzingText page2" alt="Analyzing your Designer DNA...">

    <img src="/assets/bg2.png" alt="" class="bg2 page3">

    <div class="analysis-result page3" id="analysisResult">Your outfits effortlessly echo Jacquemus' artistic mix of casual elegance and avant-garde flair, perfectly embodying a stylish, modern vibe.</div>

    <!-- Additional Images under Analysis Result -->
    <div class="resultimage1 page3">
      <img src="/assets/casual.png" class="icon-img" alt="Result Image 1" id="styleimg1">
      <img src="/assets/100.png" class="t100 page3" alt=" ">
    </div>
    <div class="resultimage2 page3">
      <img src="/assets/minimalist.png" class="icon-img" alt="Result Image 2" id="styleimg2">
      <img src="/assets/50.png" class="t50 page3" alt=" ">
    </div>
    
    <img src="/assets/dots1.png" alt="" class="dots page3">

    <div class="dna page4">
      <img src="/assets/dna.png" alt="" class="dna-img">
      <div class="designername page4" id="designername">Jacquemus</div>
      <div class="designerdesc page4" id="designerdesc">Known for bold colors and playful silhouettes, Jacquemus sets the stage for effortless chic that celebrates the body and Mediterranean aesthetics.<br><br>Founded in 2009, the brand captures the joie de vivre of Provencal life through its innovative designs. </div>
    </div>

    <img src="/assets/dots2.png" alt="" class="dots page4">

    <div class="pg4bg page5">
      <img src="/assets/pg4bg-left.png" alt="Sharing Page" class="pg4img-left">
      <img src="/assets/pg4bg-right.png" alt="Sharing Page" class="pg4img-right">
      <img src="/assets/overlaytxt.png" alt="" class="overlaytxt">
      <img src="/assets/photo1.png" alt="" class="photo1" id="photo1">
      <img src="/assets/photo2.png" alt="" class="photo2" id="photo2">
      <img src="/assets/photo3.png" alt="" class="photo3" id="photo3">
    </div>
    <div class="designername1 page5" id="designername1">Jacquemus</div>
    <div class="designerdesc1 page5" id="designerdesc1">Known for bold colors and playful silhouettes, Jacquemus sets the stage for effortless chic that celebrates the body and Mediterranean aesthetics.<br><br>Founded in 2009, the brand captures the joie de vivre of Provencal life through its innovative designs. </div>
    

    <img src="/assets/login.png" alt="Log in with Google" id="button2" class="login-button page5" onclick="handleLoginClick()">
  </div>

  <!-- Hidden File Input for Image Upload -->
  <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;" onchange="handleFilesSelected()">

  <!-- Analyzing Text -->

  <script>
    document.querySelectorAll('.page2').forEach(element => {
      element.style.display = 'none';
    });
    document.querySelectorAll('.page3').forEach(element => {
      element.style.display = 'none';
    });
    document.querySelectorAll('.page4').forEach(element => {
      element.style.display = 'none';
    });
    document.querySelectorAll('.page5').forEach(element => {
      element.style.display = 'none';
    });

    // Function to handle black square click and open file input
    function handleBlackSquareClick() {
      document.getElementById('imageUpload').click();
    }

    var file_inputs;
    const formData = new FormData();
    var aires;
    var designer_name;
    var comment;
    var intro;
    var tags;

    // Function to handle selected files
    async function handleFilesSelected() {
      const files = document.getElementById('imageUpload');

      file_inputs = Array.from(files.files).slice(0, 3);
      console.log(file_inputs)
      // if (file_inputs.length > 3) {
      //   alert("Please upload a maximum of 3 images.");
      //   return;
      // }

      // if (file_inputs.length === 0) {
      //   alert("Please select at least one image.");
      //   return;
      // }
      if (file_inputs.length != 3) {
        alert("Please upload 3 images.");
        return;
      }
      file_inputs.forEach(file => formData.append('images', file));

      var blob;

      try {
        // Prepare the form data with the first file
        // Hide all elements except the logo
        document.querySelectorAll('.page1').forEach(element => {
          element.style.display = 'none';
        });

        // Show analyzing text
        document.querySelectorAll('.page2').forEach(element => {
          element.style.display = 'block';
        });
        
        const formData = new FormData();
        formData.append('image', file_inputs[0]);

        // Call the background removal API
        const response = await fetch('/api/replicate/remove-bg', {
          method: 'POST',
          body: formData,
        });

        // Check if the response is successful
        if (!response.ok) {
          throw new Error('Failed to remove background');
        }

        // Get the JSON data (base64-encoded image) from the response
        const data = await response.json();

        // Process the returned base64 data for display
        const byteCharacters = atob(data.imageData.split(',')[1]);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        blob = new Blob([byteArray], { type: 'image/png' });
      } catch (error) {
        blob = file_inputs[0];
        console.error('Error during background removal:', error);
      }


      const reader1 = new FileReader();
      reader1.onload = function(e) {
          document.getElementById(`photo1`).src = e.target.result;
      };
      
      reader1.readAsDataURL(blob);
      
      const reader2 = new FileReader();
      reader2.onload = function(e) {
          document.getElementById(`photo2`).src = e.target.result;
      };
      
      reader2.readAsDataURL(file_inputs[1]);

      const reader3 = new FileReader();
      reader3.onload = function(e) {
          document.getElementById(`photo3`).src = e.target.result;
      };
      
      reader3.readAsDataURL(file_inputs[2]);

      

      // Send files to OpenAI API (placeholder function)
      analyzeImages();
    }

    // Placeholder function to simulate OpenAI API call
    async function analyzeImages() {
      console.log("Sending images to OpenAI API...");

      // Simulate API call delay
      // await new Promise(resolve => setTimeout(resolve, 20));
      try {
        // Send files to OpenAI analysis API
        const response = await fetch('/api/openai/analyze-images', {
          method: 'POST',
          body: formData,
        });
        const result = await response.json();
        if (response.ok) {
          aires = result.results[0];
          console.log(aires);
          try {
            designer_name = aires.match(/\*\*(.*?)\*\*/)[1];
          } catch (error) {
            designer_name = "Unknown";
            console.error('Error getting designer name:', error);
          }
          try {
            let sentences = aires.match(/[^\.!\?]+[\.!\?]+/g);
            comment = sentences[sentences.length - 1].trim();
            intro = sentences[1].trim() + "<br><br>" + sentences[2].trim();
          } catch (error) {
            comment = "Unknown";
            intro = "Unknown";
            console.error('Error getting comments:', error);
          }
          try {
            tags = aires.match(/#[\w]+/g);
          } catch (error) {
            tags = "Unknown";
            console.error('Error getting comments:', error);
          }
          tags = aires.match(/#[\w]+/g);
          document.getElementById('analysisResult').textContent = comment;
          document.getElementById('designername').textContent = designer_name;
          document.getElementById('designerdesc').innerHTML = intro;
          document.getElementById('designername1').textContent = designer_name;
          document.getElementById('designerdesc1').textContent = comment;
          console.log(designer_name);
          console.log(comment);
          console.log(intro);
          console.log(tags);
        } else {
          document.getElementById('uploadStatus').textContent = 'Analysis failed: ' + result.error;
        }
      } catch (error) {
        document.getElementById('uploadStatus').textContent = 'Analysis failed. ';
        console.error('Error analyzing images:', error);
      }

      document.querySelectorAll('.page2').forEach(element => {
        element.style.display = 'none';
      });

      // Show analyzing text
      document.querySelectorAll('.page3').forEach(element => {
        element.style.display = 'block';
      });
    }

    let startX;

    // Detect the start of a touch event
    document.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      if (document.querySelector('.page5').style.display !== 'none') {
        document.getElementById('button2').click();
      }
    });

    // Detect the end of a touch event and determine swipe direction
    document.addEventListener('touchend', (e) => {
      const endX = e.changedTouches[0].clientX;
      const deltaX = startX - endX;

      if (deltaX > 50) { // Swipe left detected
        showNextPage();
      } else if (deltaX < -50) {
        showLastPage();
      }
    });

    function showNextPage() {
      // Determine which page is currently visible and show the next page
      if (document.querySelector('.page3').style.display !== 'none') {
        // Hide page 1 and show page 2
        document.querySelectorAll('.page3').forEach(element => element.style.display = 'none');
        document.querySelectorAll('.page4').forEach(element => element.style.display = 'block');
      } else if (document.querySelector('.page4').style.display !== 'none') {
        // Hide page 2 and show page 3
        document.querySelectorAll('.page4').forEach(element => element.style.display = 'none');
        document.querySelectorAll('.page5').forEach(element => element.style.display = 'block');
      }
    }

    function showLastPage() {
      // Determine which page is currently visible and show the next page
      if (document.querySelector('.page4').style.display !== 'none') {
        // Hide page 1 and show page 2
        document.querySelectorAll('.page4').forEach(element => element.style.display = 'none');
        document.querySelectorAll('.page3').forEach(element => element.style.display = 'block');
      } else if (document.querySelector('.page5').style.display !== 'none') {
        // Hide page 2 and show page 3
        document.querySelectorAll('.page5').forEach(element => element.style.display = 'none');
        document.querySelectorAll('.page4').forEach(element => element.style.display = 'block');
      }
    }

    async function handleLoginClick() {
      if (file_inputs && file_inputs.length > 0) {
        const filesArray = [];
        for (let i = 0; i < file_inputs.length; i++) {
          filesArray.push({
            data: await fileToBase64(file_inputs[i]), // Convert file to base64 for storage
            name: file_inputs[i].name,
            type: file_inputs[i].type,
          });
        }

        // Store files and tags in localStorage
        localStorage.setItem('pendingUploadFiles', JSON.stringify(filesArray));
        localStorage.setItem('pendingUploadTags', JSON.stringify(tags));
      }

      // Proceed to Google login
      window.location.href = '/auth/google';
    }

    // Helper function to convert a file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // Detect screen width and display warning for desktop users
    function checkScreenWidth() {
      if (window.innerWidth > 768) {
        document.querySelector('.desktop-warning').style.display = 'block';
        document.querySelector('.hide-on-desktop').style.display = 'none';
      } else {
        document.querySelector('.desktop-warning').style.display = 'none';
        document.querySelector('.hide-on-desktop').style.display = 'flex';
      }
    }

    // Initial check and resize event listener
    checkScreenWidth();
    window.addEventListener('resize', checkScreenWidth);

    async function checkAndUploadPendingFiles() {
      // Retrieve pending files and tags from localStorage
      console.log(1);
      const pendingFiles = JSON.parse(localStorage.getItem('pendingUploadFiles'));
      const pendingTags = JSON.parse(localStorage.getItem('pendingUploadTags'));
      console.log(pendingFiles);
      console.log(pendingTags);
      if (pendingFiles && pendingFiles.length > 0) {
        console.log(3);
        const formData = new FormData();

        pendingFiles.forEach((file, index) => {
          console.log(6);
          const blob = base64ToBlob(file.data, file.type);
          console.log(blob);
          console.log(file.data);
          formData.append('images', blob, file.name);
        });
        formData.append('tags', pendingTags);
        for (let [key, value] of formData.entries()) {
          console.log(key, value);
        }

        try {
          // Upload images and tags to the server
          const response = await fetch('/upload', {
            method: 'POST',
            body: formData,
          });

          if (response && response.ok) {
            console.log('Images uploaded successfully');
            // Clear localStorage after successful upload
            localStorage.removeItem('pendingUploadFiles');
            localStorage.removeItem('pendingUploadTags');
          } else {
            console.error('Image upload failed:', response.status);
          }
        } catch (error) {
          console.error('Error uploading images:', error);
        }
      }
    }

    // Helper function to convert base64 back to a Blob
    function base64ToBlob(base64, mimeType) {
      const byteString = atob(base64.split(',')[1]);
      const arrayBuffer = new ArrayBuffer(byteString.length);
      const uint8Array = new Uint8Array(arrayBuffer);
      for (let i = 0; i < byteString.length; i++) {
        uint8Array[i] = byteString.charCodeAt(i);
      }
      return new Blob([arrayBuffer], { type: mimeType });
    }

    // Call this function on the page after login (e.g., in home.html)
    document.addEventListener('DOMContentLoaded', checkAndUploadPendingFiles);

    document.querySelector('.login-button.page5').addEventListener('touchstart', handleLoginClick);

  </script>

</body>
</html>
